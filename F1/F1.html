<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Sessions + Graphiques Dynamiques</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="F1_style.css">
</head>
<body>
      <div class="container">
        <a href="../index.html" class="nav-logo">Profil</a>
        <a href="../outils/outils.html" class="nav-logo">‚Üê Outils</a>
      </div>
    <!-- S√©lecteur d'√©quipe favorite -->
    <div class="team-selector-container">
        <label for="favoriteTeam"> √âquipe Favorite:</label>
        <select id="favoriteTeam" class="team-selector" onchange="changeTeamTheme()">
            <option value="mclaren" selected>McLaren</option>
            <option value="redbull">Red Bull</option>
            <option value="mercedes">Mercedes</option>
            <option value="ferrari">Ferrari</option>
            <option value="astonmartin">Aston Martin</option>
            <option value="alpine">Alpine</option>
            <option value="williams">Williams</option>
            <option value="haas">Haas</option>
            <option value="sauber">Sauber</option>
            <option value="rb">RB F1 Team</option>
            <option value="cadillac">Cadillac</option>
            <option value="audi">Audi</option>
        </select>
    </div>

    <h1>F1 <span id="displayYear">2025</span> Sessions </h1>
    
    <div id="charts-section">
        <h2> Analyses & Comparaisons</h2>
        
        <div class="controls">
            <select id="seasonYear" class="year-select" onchange="changeYear()">
               <!--- <option value="2026" >Saison 2026</option> --->
                <option value="2025" selected>Saison 2025</option>
                <option value="2024">Saison 2024</option>
                <option value="2023">Saison 2023</option>
                <option value="2022">Saison 2022</option>
                <option value="2021">Saison 2021</option>
                <option value="2020">Saison 2020</option>
                <option value="2019">Saison 2019</option>
                <option value="2018">Saison 2018</option>
                <option value="2017">Saison 2017</option>
            </select>

            <div class="multi-select-container">
                <div class="multi-select-header" onclick="toggleDropdown()">
                    <span id="selectedCount">S√©lectionner pilotes/√©quipes</span>
                    <span>‚ñº</span>
                </div>
                <div id="multiSelectDropdown" class="multi-select-dropdown">
                    <div class="select-group">
                        <div class="select-group-title"> PILOTES</div>
                        <div id="driverOptions"></div>
                    </div>
                    <div class="select-group">
                        <div class="select-group-title"> √âQUIPES</div>
                        <div id="teamOptions"></div>
                    </div>
                </div>
            </div>
            
            <select id="chartType" onchange="resetAnimationIndex()">
                <option value="cumulative"> Points Cumulatifs</option>
                <option value="position"> Positions</option>
                <option value="points"> Points par Course</option>
            </select>
            
            <button class="update-btn" onclick="updateCharts()">Actualiser</button>
            <button class="update-btn animate-btn" onclick="animateChart()"> Lancer l'Animation</button>
            <button class="update-btn clear-btn" onclick="clearSelection()"> Effacer</button>
        </div>
        
        <div class="chart-container">
            <canvas id="mainChart"></canvas>
        </div>
        
        <div id="stats"></div>
    </div>

    
   
   

    <div id="driverStandings"></div>
    

    <h2>üèÅ Courses de la saison</h2>
    <div id="raceList" class="race-list"></div>
    <div id="details" class="details"></div>

    <script>
        let allData = {};
        let pilots = new Set();
        let teams = new Set();
        let chart = null;
        let animationInterval = null;
        let currentProgressIndex = 0;
        let currentPitstops = {};
        const colors = ['#FF6600', '#00ff88', '#3b82f6', '#f59e0b', '#ec4899', '#8b5cf6', '#10b981', '#ef4444'];

        // Th√®mes des √©quipes
        const teamThemes = {
            mclaren: { primary: '#FF6600', light: '#ff8c42', name: 'McLaren' },
            redbull: { primary: '#0600EF', light: '#3923F6', name: 'Red Bull' },
            mercedes: { primary: '#00D2BE', light: '#27F4E2', name: 'Mercedes' },
            ferrari: { primary: '#DC0000', light: '#FF2800', name: 'Ferrari' },
            astonmartin: { primary: '#006F62', light: '#229B8D', name: 'Aston Martin' },
            alpine: { primary: '#0090FF', light: '#2DB1FF', name: 'Alpine' },
            williams: { primary: '#005AFF', light: '#37B6FF', name: 'Williams' },
            haas: { primary: '#FFFFFF', light: '#B6BABD', name: 'Haas' },
            sauber: { primary: '#52E252', light: '#7FFF7F', name: 'Sauber' },
            rb: { primary: '#6692FF', light: '#8AB1FF', name: 'RB F1 Team' },
            cadillac: { primary: '#AA0000', light: '#DD3333', name: 'Cadillac' },
            audi: { primary: '#C0C0C0', light: '#E0E0E0', name: 'Audi' }
        };

        function changeTeamTheme() {
            const team = document.getElementById('favoriteTeam').value;
            const theme = teamThemes[team];
            
            document.documentElement.style.setProperty('--mclaren-orange', theme.primary);
            document.documentElement.style.setProperty('--mclaren-light', theme.light);
            
            document.querySelector('h1').innerHTML = `üèéÔ∏è F1 <span id="displayYear">${document.getElementById('displayYear').textContent}</span> Saison  ${theme.name}`;
        }

        function changeYear() {
            const year = document.getElementById('seasonYear').value;
            document.getElementById('displayYear').innerText = year;
            
            if (chart) chart.destroy();
            chart = null;
            currentProgressIndex = 0;
            if (animationInterval) cancelAnimationFrame(animationInterval);
            
            document.getElementById('details').style.display = 'none';
            loadData(year);
        }

        async function loadData(year = "2025") {
            try {
                const response = await fetch(`f1_complet_sessions_${year}.json`);
                allData = await response.json();
                
                displayRaces(allData);
                extractPilotsTeams(allData);
                displayDriverStandings();
                populateMultiSelect();
                

                
                updateCharts(); 
            } catch (error) {
                console.error("Erreur de chargement du fichier JSON:", error);
                document.getElementById('raceList').innerHTML = `<p style="color:red;">‚ùå Fichier f1_complet_sessions_${year}.json introuvable.</p>`;
            }
        }

        function extractPilotsTeams(data) {
            pilots.clear(); teams.clear();
            Object.values(data.courses).forEach(course => {
                if (course.sessions?.race) {
                    course.sessions.race.forEach(row => {
                        if (row.driver) pilots.add(row.driver);
                        if (row.team) teams.add(row.team);
                    });
                }
            });
        }

        function populateMultiSelect() {
            const dOpt = document.getElementById('driverOptions');
            const tOpt = document.getElementById('teamOptions');
            dOpt.innerHTML = ''; tOpt.innerHTML = '';
            Array.from(pilots).sort().forEach(p => {
                dOpt.innerHTML += `<div class="select-option"><input type="checkbox" id="p_${p}" value="${p}" data-type="pilot" onchange="updateSelectedCount()"><label for="p_${p}">${p}</label></div>`;
            });
            Array.from(teams).sort().forEach(t => {
                tOpt.innerHTML += `<div class="select-option"><input type="checkbox" id="t_${t}" value="${t}" data-type="team" onchange="updateSelectedCount()"><label for="t_${t}">${t}</label></div>`;
            });
            document.getElementById('selectedCount').textContent = 'S√©lectionner pilotes/√©quipes';
        }

        function toggleDropdown() { 
            document.getElementById('multiSelectDropdown').classList.toggle('active'); 
        }

        function updateSelectedCount() {
            const checked = document.querySelectorAll('#multiSelectDropdown input[type="checkbox"]:checked');
            document.getElementById('selectedCount').textContent = checked.length === 0 ? 'S√©lectionner pilotes/√©quipes' : `${checked.length} s√©lectionn√©(s)`;
            if (chart && !animationInterval) syncStaticChart();
        }

        function getLabels() {
            if (!allData.courses) return [];
            return Object.keys(allData.courses).sort((a,b) => parseInt(a) - parseInt(b))
                .map(k => allData.courses[k].race_name.replace('Grand Prix', 'GP'));
        }

        function resetAnimationIndex() {
            currentProgressIndex = 0;
            if (chart) { chart.destroy(); chart = null; }
            updateCharts();
        }

        function clearSelection() {
            document.querySelectorAll('#multiSelectDropdown input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateSelectedCount();
            currentProgressIndex = 0;
            if (animationInterval) cancelAnimationFrame(animationInterval);
            animationInterval = null;
            if (chart) { chart.destroy(); chart = null; }
            updateCharts();
        }

        function syncStaticChart() {
            const checked = document.querySelectorAll('#multiSelectDropdown input[type="checkbox"]:checked');
            const chartType = document.getElementById('chartType').value;
            const labels = getLabels();

            const datasets = Array.from(checked).map((cb, idx) => {
                const source = cb.dataset.type === 'pilot' ? getDriverData(cb.value, chartType) : getTeamData(cb.value, chartType);
                return {
                    label: cb.value,
                    data: source.values.slice(0, currentProgressIndex || source.values.length),
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length] + '33',
                    tension: 0.4,
                    borderDash: cb.dataset.type === 'team' ? [5, 5] : []
                };
            });
            renderChart(datasets, chartType, labels);
        }

        function updateCharts() {
            if (animationInterval) cancelAnimationFrame(animationInterval);
            animationInterval = null;
            const labels = getLabels();
            currentProgressIndex = labels.length; 
            syncStaticChart();
        }

        function animateChart() {
            if (animationInterval) cancelAnimationFrame(animationInterval);
            const labels = getLabels();
            const checked = document.querySelectorAll('#multiSelectDropdown input[type="checkbox"]:checked');
            const chartType = document.getElementById('chartType').value;
            if (checked.length === 0) return alert("S√©lectionnez d'abord quelqu'un !");
            if (currentProgressIndex >= labels.length) currentProgressIndex = 0;

            const fullSources = Array.from(checked).map(cb => 
                cb.dataset.type === 'pilot' ? getDriverData(cb.value, chartType) : getTeamData(cb.value, chartType)
            );

            const initialDatasets = Array.from(checked).map((cb, idx) => ({
                label: cb.value,
                data: fullSources[idx].values.slice(0, currentProgressIndex),
                borderColor: colors[idx % colors.length],
                tension: 0.4
            }));
            renderChart(initialDatasets, chartType, labels);

            let lastTime = Date.now();
            function step() {
                const now = Date.now();
                if (now - lastTime >= 200) {
                    if (currentProgressIndex >= labels.length) {
                        animationInterval = null;
                        return;
                    }
                    chart.data.datasets.forEach((ds, i) => {
                        ds.data.push(fullSources[i].values[currentProgressIndex]);
                    });
                    chart.update();
                    currentProgressIndex++;
                    lastTime = now;
                }
                animationInterval = requestAnimationFrame(step);
            }
            animationInterval = requestAnimationFrame(step);
        }

        function renderChart(datasets, type, labels) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { reverse: type === 'position', ticks: { color: 'white' } },
                        x: { ticks: { color: 'white' } }
                    },
                    plugins: { legend: { labels: { color: 'white' } } }
                }
            });
        }

        function getDriverData(driver, type) {
            let cumulative = 0;
            const values = Object.keys(allData.courses).sort((a,b) => parseInt(a)-parseInt(b)).map(k => {
                const res = allData.courses[k].sessions?.race?.find(r => r.driver === driver);
                const p = res ? parseFloat(res.points) || 0 : 0;
                cumulative += p;
                if (type === 'cumulative') return cumulative;
                if (type === 'position') return res ? parseInt(res.position) || 20 : 20;
                return p;
            });
            return { values };
        }

        function getTeamData(team, type) {
            let cumulative = 0;
            const values = Object.keys(allData.courses).sort((a,b) => parseInt(a)-parseInt(b)).map(k => {
                const res = allData.courses[k].sessions?.race?.filter(r => r.team === team) || [];
                const p = res.reduce((sum, r) => sum + (parseFloat(r.points) || 0), 0);
                cumulative += p;
                if (type === 'cumulative') return cumulative;
                if (type === 'position') return res.length ? Math.min(...res.map(r => parseInt(r.position))) : 20;
                return p;
            });
            return { values };
        }

        function displayRaces(data) {
            const list = document.getElementById('raceList');
            list.innerHTML = '';
            if (!data.courses) return;
            Object.values(data.courses).forEach(course => {
                const card = document.createElement('div');
                card.className = 'race-card';
                card.onclick = () => showDetails(course);
                card.innerHTML = `
                    <h3>${course.race_name}</h3>
                    <p><strong>Round:</strong> ${course.round}</p>
                    <p><strong>Circuit:</strong> ${course.circuit}</p>
                `;
                list.appendChild(card);
            });
        }

        function showDetails(course) {
            const details = document.getElementById('details');
            details.style.display = 'block';
            currentPitstops = course.pitstops || {};
            
            details.innerHTML = `
                <h2>${course.race_name} - Round ${course.round}</h2>
                <p><strong>Circuit:</strong> ${course.circuit}</p>
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTabDirect('race', event)"> Course</button>
                    <button class="tab-btn" onclick="switchTabDirect('qualifying', event)"> Qualifications</button>
                    <button class="tab-btn" onclick="switchTabDirect('pitstops', event)"> Arr√™ts aux Stands</button>
                </div>
                <div id="raceTab" class="tab-content active">${renderRaceTable(course.sessions.race)}</div>
                <div id="qualifyingTab" class="tab-content">${renderQualifyingTable(course.sessions.qualifying)}</div>
                <div id="pitstopsTab" class="tab-content">${renderPitstops(currentPitstops)}</div>
            `;
            
            details.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function switchTabDirect(tabName, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            const allButtons = document.querySelectorAll('.tab-btn');
            allButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }
     
        function displayDriverStandings() {
    const container = document.getElementById('driverStandings');
    if (!container || !allData || !allData.courses) return;

    const standings = {};

    // Couleurs des √©quipes
    const teamColors = {
        'McLaren': '#FF6600',
        'Red Bull': '#0600EF',
        'Mercedes': '#00D2BE',
        'Ferrari': '#DC0000',
        'Aston Martin': '#006F62',
        'Alpine': '#0090FF',
        'Williams': '#005AFF',
        'Haas': '#B6BABD',
        'Sauber': '#52E252',
        'RB': '#6692FF',
        'RB F1 Team': '#6692FF',
        'Cadillac': '#AA0000',
        'Audi': '#C0C0C0'
    };

    // Calculer les points
    Object.values(allData.courses).forEach(course => {
        if (course.sessions?.race) {
            course.sessions.race.forEach(result => {
                const name = result.driver;
                if (!name) return;
                
                if (!standings[name]) {
                    standings[name] = {
                        points: 0,
                        team: result.team || "N/A",
                        code: result.code || name.substring(0, 3).toUpperCase()
                    };
                }
                standings[name].points += parseFloat(result.points) || 0;
            });
        }
    });

    // Trier
    const sorted = Object.entries(standings).sort((a, b) => b[1].points - a[1].points);

    // Style du container
    container.style.cssText = `
        max-width: 1200px;
        margin: 30px auto;
        padding: 20px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 15px;
        backdrop-filter: blur(10px);
    `;

    // G√©n√©rer le HTML
    let html = '<h3 style="color: var(--mclaren-orange); text-align: center; font-size: 2em; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 3px;"> CLASSEMENT PILOTES</h3>';
    
    html += '<table style="width: 100%; border-collapse: collapse;"><thead><tr>';
    html += '<th style="background: linear-gradient(135deg, rgba(255,102,0,0.5), rgba(255,140,66,0.3)); padding: 15px; text-align: center; font-weight: 700; text-transform: uppercase; letter-spacing: 2px;">POS</th>';
    html += '<th style="background: linear-gradient(135deg, rgba(255,102,0,0.5), rgba(255,140,66,0.3)); padding: 15px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 2px;">PILOTE</th>';
    html += '<th style="background: linear-gradient(135deg, rgba(255,102,0,0.5), rgba(255,140,66,0.3)); padding: 15px; text-align: center; font-weight: 700; text-transform: uppercase; letter-spacing: 2px;">CODE</th>';
    html += '<th style="background: linear-gradient(135deg, rgba(255,102,0,0.5), rgba(255,140,66,0.3)); padding: 15px; text-align: center; font-weight: 700; text-transform: uppercase; letter-spacing: 2px;">√âQUIPE</th>';
    html += '<th style="background: linear-gradient(135deg, rgba(255,102,0,0.5), rgba(255,140,66,0.3)); padding: 15px; text-align: center; font-weight: 700; text-transform: uppercase; letter-spacing: 2px;">POINTS</th>';
    html += '</tr></thead><tbody>';
    
    sorted.forEach(([name, data], i) => {
        const pos = i + 1;
        const bgColor = pos <= 3 ? 'background: rgba(255,102,0,0.15);' : '';
        const teamColor = teamColors[data.team] || '#FF6600';
        const textColor = data.team === 'Haas' ? '#333' : 'white';
        
        html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.1); transition: all 0.3s; ${bgColor}" onmouseover="this.style.background='rgba(255,102,0,0.2)'; this.style.transform='translateX(5px)';" onmouseout="this.style.background='${pos <= 3 ? 'rgba(255,102,0,0.15)' : 'transparent'}'; this.style.transform='translateX(0)';">`;
        
        html += `<td style="padding: 15px; text-align: center; color: var(--mclaren-orange); font-size: 20px; font-weight: bold;">${pos}</td>`;
        
        html += `<td style="padding: 15px; text-align: left; text-transform: uppercase; font-weight: 600; font-size: 16px;">${name}</td>`;
        
        html += `<td style="padding: 15px; text-align: center;"><span style="background: ${teamColor}; color: ${textColor}; padding: 5px 12px; border-radius: 5px; font-weight: bold; font-size: 14px; display: inline-block;">${data.code}</span></td>`;
        
        html += `<td style="padding: 15px; text-align: center; color: #aaa; font-size: 14px;">${data.team}</td>`;
        
        html += `<td style="padding: 15px; text-align: center; font-size: 20px; font-weight: bold; color: var(--mclaren-light); text-shadow: 0 0 10px rgba(255,102,0,0.3);">${Math.round(data.points)}</td>`;
        
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}




        function renderRaceTable(data) {
            if (!data || data.length === 0) return '<p>Aucune donn√©e disponible.</p>';
            let html = '<table><thead><tr><th>Position</th><th>Pilote</th><th>Code</th><th>√âquipe</th><th>Points</th><th>Meilleur Tour</th><th>Classement Tour Rapide</th></tr></thead><tbody>';
            data.forEach(row => {
                html += `<tr>
                    <td>${row.position || 'N/A'}</td>
                    <td>${row.driver || 'N/A'}</td>
                    <td>${row.code || 'N/A'}</td>
                    <td>${row.team || 'N/A'}</td>
                    <td><strong>${row.points || '0'}</strong></td>
                    <td>${row.fastest_lap_time || 'N/A'}</td>
                    <td>${row.fastest_lap_rank || 'N/A'}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            return html;
        }

        function renderQualifyingTable(data) {
            if (!data || data.length === 0) return '<p>Aucune donn√©e disponible.</p>';
            let html = '<table><thead><tr><th>Position</th><th>Pilote</th><th>Q1</th><th>Q2</th><th>Q3</th></tr></thead><tbody>';
            data.forEach(row => {
                html += `<tr>
                    <td>${row.position || 'N/A'}</td>
                    <td>${row.driver || 'N/A'}</td>
                    <td>${row.q1 || 'N/A'}</td>
                    <td>${row.q2 || 'N/A'}</td>
                    <td>${row.q3 || 'N/A'}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            return html;
        }

        function renderPitstops(pitstops) {
            if (!pitstops || Object.keys(pitstops).length === 0) return '<p>Aucun arr√™t aux stands enregistr√©.</p>';
            
            const driverKeys = Object.keys(pitstops).sort();
            let html = `
                <div class="driver-selector">
                    <label for="driverFilter"> S√©lectionner un pilote:</label>
                    <select id="driverFilter" onchange="filterPitstops()">
                        <option value="all"> Tous les pilotes</option>
                        ${driverKeys.map(driver => `<option value="${driver}">${driver.replace(/_/g, ' ').toUpperCase()}</option>`).join('')}
                    </select>
                </div>
                <div id="pitstopsContent">
                    ${renderAllPitstops(pitstops)}
                </div>
            `;
            return html;
        }

        function renderAllPitstops(pitstops) {
            let html = '';
            Object.keys(pitstops).sort().forEach(driver => {
                html += `<div class="driver-pitstop-section" data-driver="${driver}">`;
                html += `<h4> ${driver.replace(/_/g, ' ').toUpperCase()}</h4>`;
                html += '<table><thead><tr><th>Tour</th><th>Arr√™t N¬∞</th><th>Dur√©e</th></tr></thead><tbody>';
                pitstops[driver].forEach(stop => {
                    html += `<tr><td>${stop.lap}</td><td>${stop.stop}</td><td>${stop.duration}</td></tr>`;
                });
                html += '</tbody></table>';
                html += '</div>';
            });
            return html;
        }

        function filterPitstops() {
            const selectedDriver = document.getElementById('driverFilter').value;
            const allSections = document.querySelectorAll('.driver-pitstop-section');
            
            allSections.forEach(section => {
                if (selectedDriver === 'all') {
                    section.style.display = 'block';
                } else {
                    section.style.display = section.dataset.driver === selectedDriver ? 'block' : 'none';
                }
            });
        }

        window.onload = function() {
    loadData("2025");
    };
    </script>
</body>
</html>
